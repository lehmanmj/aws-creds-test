name: 111Static role chain testing
on:
    workflow_dispatch:

jobs:
    do-the-thing:
        name: test out role chaining account number
        permissions:
            id-token: write
        runs-on: ubuntu-latest
        steps:
          - name: OIDC call
            id: assume-oidc
            uses: aws-actions/configure-aws-credentials@v4
            with:
                role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
                aws-region: ca-central-1
                role-skip-session-tagging: true
                mask-aws-account-id: false
        
          - name: OIDC spoke 1
            id: oidc-spoke-lv-1
            uses: aws-actions/configure-aws-credentials@v4
            with:
                role-to-assume: arn:aws:iam::884348119369:role/new-Spoke-Test-outputs
                aws-region: ca-central-1
                role-skip-session-tagging: true
                role-chaining: true
                mask-aws-account-id: false

          - name: OIDC spoke 2
            id: oidc-spoke-lv-2
            uses: aws-actions/configure-aws-credentials@v4
            with:
                role-to-assume: arn:aws:iam::884348119369:role/oidc-spoke-level-2
                aws-region: ca-central-1
                role-skip-session-tagging: true
                role-chaining: true
                mask-aws-account-id: false
            
          - name: first static
            id: static-1
            uses: aws-actions/configure-aws-credentials@v4
            with:
                role-to-assume: arn:aws:iam::884348119369:role/static-role-1
                aws-access-key-id: ${{ secrets.STATIC_1_AK_ID }}
                aws-secret-access-key: ${{ secrets.STATIC_1_SECRET_AK }}
                aws-region: ca-central-1
                role-skip-session-tagging: true
                mask-aws-account-id: false
          
          - name: second static
            id: static-2
            uses: aws-actions/configure-aws-credentials@v4
            with:
                role-to-assume: arn:aws:iam::884348119369:role/static-role-2
                aws-access-key-id: ${{ secrets.STATIC_2_AK_ID }}
                aws-secret-access-key: ${{ secrets.STATIC_2_SECRET_AK }}
                aws-region: ca-central-1
                role-skip-session-tagging: true
                mask-aws-account-id: false

          - name: static-spoke
            id: static-2-spoke
            uses: aws-actions/configure-aws-credentials@v4
            with:
                role-to-assume: arn:aws:iam::884348119369:role/static-role-2-spoke
                aws-region: ca-central-1
                role-chaining: true
                role-skip-session-tagging: true
                mask-aws-account-id: false

          - name: Debug build spoke identity
            run: |
                aws sts get-caller-identity
                echo "ASSUME_OIDC_ACCOUNT=${{ steps.assume-oidc.outputs.aws-account-id }}"
                echo "ASSUME_OIDC_ARN=${{ steps.assume-oidc.outputs.authenticated-arn }}"
                echo "OIDC_SPOKE_1_ACCOUNT=${{ steps.oidc-spoke-lv-1.outputs.aws-account-id }}"
                echo "OIDC_SPOKE_1_ARN=${{ steps.oidc-spoke-lv-1.outputs.authenticated-arn }}"
                echo "OIDC_SPOKE_2_ACCOUNT=${{ steps.oidc-spoke-lv-2.outputs.aws-account-id }}"
                echo "OIDC_SPOKE_2_ARN=${{ steps.oidc-spoke-lv-2.outputs.authenticated-arn }}"
                echo "STATIC_1_ACCOUNT=${{ steps.static-1.outputs.aws-account-id }}"
                echo "STATIC_1_ARN=${{ steps.static-1.outputs.authenticated-arn }}"
                echo "STATIC_2_ACCOUNT=${{ steps.static-2.outputs.aws-account-id }}"
                echo "STATIC_2_ARN=${{ steps.static-2.outputs.authenticated-arn }}"
                echo "2SPOKE_ACCOUNT=${{ steps.static-2-spoke.outputs.aws-account-id }}"
                echo "2SPOKE_ARN=${{ steps.static-2-spoke.outputs.authenticated-arn }}"