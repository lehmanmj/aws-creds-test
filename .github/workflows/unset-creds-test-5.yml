name: unset-creds-test-5
on:
  workflow_dispatch:

jobs:
  cawsc:  
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      # I expect this to populate a bunch of `AWS_` variables, which it does correctly.
      - name: Configure AWS Credentials
        id: firstCreds
        uses: aws-actions/configure-aws-credentials@output-expiration
        with:
          aws-region: us-east-1
          role-to-assume: arn:aws:iam::891612571239:role/S3-Read-CAWSC-Test
          output-credentials: true

      # I expect this to be able to use the `AWS_` variables, which it does correctly
      - name: Terraform init
        env:
          FIRST_EXP: ${{ steps.firstCreds.outputs.aws-expiration }}
        run: echo "First set of credentials expire at $FIRST_EXP".

      # I expect this to wipe the `AWS_` variables, but instead it errors out
      - name: Unset terraform aws credentials
        id: creds2
        uses: aws-actions/configure-aws-credentials@output-expiration
        with:
          aws-region: us-east-1
          role-to-assume: arn:aws:iam::891612571239:role/Chime-Read-CAWSC-Test
          output-credentials: true

      # This last step and any subsequent step should no longer have any access to AWS credentials
      - name: Some random thing that might be insecure and even if its secure, it doesn't need AWS credentials
        env:
          FIRST_EXP: ${{ steps.firstCreds.outputs.aws-expiration }}
          SECOND_EXP: ${{ steps.creds2.outputs.aws-expiration }}
        run: |
          echo "First set of credentials expire at $FIRST_EXP"
          echo "Second set of credentials expire at $SECOND_EXP"